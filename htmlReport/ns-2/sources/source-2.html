


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > BookingService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">ru.practicum.shareit.booking</a>
</div>

<h1>Coverage Summary for Class: BookingService (ru.practicum.shareit.booking)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">BookingService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (8/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    87.8%
  </span>
  <span class="absValue">
    (86/98)
  </span>
</td>
</tr>
  <tr>
    <td class="name">BookingService$$EnhancerBySpringCGLIB$$54840314</td>
  </tr>
  <tr>
    <td class="name">BookingService$$EnhancerBySpringCGLIB$$54840314$$FastClassBySpringCGLIB$$e3f833ae</td>
  </tr>
  <tr>
    <td class="name">BookingService$$EnhancerBySpringCGLIB$$7c091758</td>
  </tr>
  <tr>
    <td class="name">BookingService$$FastClassBySpringCGLIB$$3a42d9cc</td>
  </tr>
  <tr>
    <td class="name">BookingService$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$42YfP7gw</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$42YfP7gw$auxiliary$64isl4A6</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$42YfP7gw$auxiliary$AKlwFwHU</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$42YfP7gw$auxiliary$G8Pfmi1M</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$42YfP7gw$auxiliary$IdEHUNcl</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$42YfP7gw$auxiliary$K9LI4alc</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$42YfP7gw$auxiliary$SCFUuKPJ</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$42YfP7gw$auxiliary$ZFjvEXwO</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$forRb8IZ</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$forRb8IZ$auxiliary$3HFhyDn6</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$forRb8IZ$auxiliary$6P1okoQk</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$forRb8IZ$auxiliary$EaMdSuBO</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$forRb8IZ$auxiliary$FMyy3PPN</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$forRb8IZ$auxiliary$HgIHEeH8</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$forRb8IZ$auxiliary$nERX8prw</td>
  </tr>
  <tr>
    <td class="name">BookingService$MockitoMock$forRb8IZ$auxiliary$QQgUVqnO</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (9/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    87.9%
  </span>
  <span class="absValue">
    (87/99)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package ru.practicum.shareit.booking;
&nbsp;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.data.domain.PageRequest;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import ru.practicum.shareit.booking.dto.BookingDTOValidator;
&nbsp;import ru.practicum.shareit.booking.dto.BookingDto;
&nbsp;import ru.practicum.shareit.booking.dto.BookingExtendedDto;
&nbsp;import ru.practicum.shareit.booking.dto.BookingMapper;
&nbsp;import ru.practicum.shareit.booking.storage.BookingRepository;
&nbsp;import ru.practicum.shareit.exception.NotFoundException;
&nbsp;import ru.practicum.shareit.item.Item;
&nbsp;import ru.practicum.shareit.item.storage.ItemRepository;
&nbsp;import ru.practicum.shareit.user.User;
&nbsp;import ru.practicum.shareit.user.storage.UserRepository;
&nbsp;
&nbsp;import java.security.InvalidParameterException;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.List;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;@Service
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;public class BookingService {
&nbsp;
&nbsp;    private final BookingRepository bookingRepository;
&nbsp;    private final UserRepository userRepository;
&nbsp;    private final ItemRepository itemRepository;
&nbsp;
&nbsp;    @Autowired
<b class="fc">&nbsp;    public BookingService(BookingRepository bookingRepository, UserRepository userRepository, ItemRepository itemRepository) {</b>
<b class="fc">&nbsp;        this.bookingRepository = bookingRepository;</b>
<b class="fc">&nbsp;        this.userRepository = userRepository;</b>
<b class="fc">&nbsp;        this.itemRepository = itemRepository;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    public BookingExtendedDto createBooking(Integer userId, BookingDto bookingDto) {
<b class="fc">&nbsp;        log.info(&quot;??????? ?????? ? ??????: {}. ???????? ??????????: {}, {}&quot;, &quot;createBooking&quot;, userId, bookingDto);</b>
&nbsp;
<b class="fc">&nbsp;        User user = null;</b>
<b class="fc">&nbsp;        Item item = null;</b>
&nbsp;
&nbsp;        try {
<b class="fc">&nbsp;            user = userRepository.findById(userId).get();</b>
<b class="fc">&nbsp;            item = itemRepository.findById(bookingDto.getItemId()).get();</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            throw new NotFoundException(&quot;?? ??????? ????????? ????????.&quot; + e.getMessage());</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="fc">&nbsp;        var validationResult = BookingDTOValidator.validateCreation(bookingDto);</b>
&nbsp;
<b class="fc">&nbsp;        if (validationResult.size() &gt; 0) {</b>
<b class="fc">&nbsp;            throw new InvalidParameterException(validationResult.get(0));</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (!item.getAvailable()) {</b>
<b class="nc">&nbsp;            throw new InvalidParameterException(&quot;&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        if (item.getOwner().getId().equals(userId)) {</b>
<b class="nc">&nbsp;            throw new NotFoundException(&quot;&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        var booking = BookingMapper.toBooking(bookingDto);</b>
<b class="fc">&nbsp;        booking.setBooker(user);</b>
<b class="fc">&nbsp;        booking.setItem(item);</b>
<b class="fc">&nbsp;        booking.setStatus(BookingStatus.WAITING);</b>
<b class="fc">&nbsp;        booking = bookingRepository.save(booking);</b>
&nbsp;
<b class="fc">&nbsp;        return BookingMapper.toExtendedBookingDto(booking);</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;BookingExtendedDto&gt; getBookingsByOwnerId(Integer userId, BookingState bookingState, Integer from, Integer size) {
<b class="fc">&nbsp;        log.info(&quot;??????? ?????? ? ??????: {}. ???????? ??????????: {}, {}&quot;, &quot;getBookingsByOwnerId&quot;, userId, bookingState);</b>
&nbsp;
<b class="fc">&nbsp;        if (bookingRepository.findOwnerById(userId).size() == 0) {</b>
<b class="nc">&nbsp;            throw new NotFoundException(&quot;???????? ???? ?? ??????&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (from == null &amp;&amp; size == null) {</b>
<b class="fc">&nbsp;            from = 0;</b>
<b class="fc">&nbsp;            size = Integer.MAX_VALUE;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        var pageRequest = getPage(from, size);</b>
&nbsp;
&nbsp;        List&lt;Booking&gt; bookings;
&nbsp;
<b class="fc">&nbsp;        switch (bookingState) {</b>
&nbsp;            case ALL:
<b class="fc">&nbsp;                bookings = bookingRepository.findAllBookingsByOwnerId(userId, null, pageRequest);</b>
<b class="fc">&nbsp;                break;</b>
&nbsp;            case WAITING:
&nbsp;            case REJECTED:
<b class="fc">&nbsp;                var bookingStatus = bookingState.equals(BookingState.WAITING) ? BookingStatus.WAITING.toString() : BookingStatus.REJECTED.toString();</b>
<b class="fc">&nbsp;                bookings = bookingRepository.findAllBookingsByOwnerId(userId, bookingStatus, pageRequest);</b>
<b class="fc">&nbsp;                break;</b>
&nbsp;            case CURRENT:
<b class="fc">&nbsp;                bookings = bookingRepository.findAllCurrentBookingsByOwnerIdWithFetch(userId, LocalDateTime.now(), pageRequest);</b>
<b class="fc">&nbsp;                break;</b>
&nbsp;            case PAST:
<b class="fc">&nbsp;                bookings = bookingRepository.findAllPastBookingsByOwnerIdWithFetch(userId, LocalDateTime.now(), pageRequest);</b>
<b class="fc">&nbsp;                break;</b>
&nbsp;            case FUTURE:
<b class="fc">&nbsp;                bookings = bookingRepository.findAllFutureBookingsByOwnerIdWithFetch(userId, LocalDateTime.now(), pageRequest);</b>
<b class="fc">&nbsp;                break;</b>
&nbsp;            default:
<b class="nc">&nbsp;                throw new NotFoundException(&quot;&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return bookings.stream()</b>
<b class="fc">&nbsp;                .map(x -&gt; BookingMapper.toExtendedBookingDto(x))</b>
<b class="fc">&nbsp;                .collect(Collectors.toList());</b>
&nbsp;    }
&nbsp;
&nbsp;    public BookingExtendedDto getBookingById(Integer userId, Integer bookingId) {
<b class="fc">&nbsp;        log.info(&quot;??????? ?????? ? ??????: {}. ???????? ??????????: {}, {}&quot;, &quot;getBookingById&quot;, userId, bookingId);</b>
&nbsp;
<b class="fc">&nbsp;        Booking booking = null;</b>
<b class="fc">&nbsp;        User user = null;</b>
&nbsp;
&nbsp;        try {
<b class="fc">&nbsp;            booking = bookingRepository.findById(bookingId).get();</b>
<b class="fc">&nbsp;            user = userRepository.findById(userId).get();</b>
<b class="fc">&nbsp;        } catch (Exception e) {</b>
<b class="fc">&nbsp;            throw new NotFoundException(&quot;&quot;);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="fc">&nbsp;        if (!userId.equals(booking.getBooker().getId()) &amp;&amp; !userId.equals(booking.getItem().getOwner().getId())) {</b>
<b class="nc">&nbsp;            throw new NotFoundException(&quot;???????????? ?? ???????? ?? ?????????? ?? ?????????????&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return BookingMapper.toExtendedBookingDto(booking);</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;BookingExtendedDto&gt; getAllBookingsByUserId(Integer userId, BookingState bookingState, Integer from, Integer size) {
<b class="fc">&nbsp;        log.info(&quot;??????? ?????? ? ??????: {}. ???????? ??????????: {}, {}&quot;, &quot;getAllBookingsByUserId&quot;, userId, bookingState);</b>
&nbsp;
&nbsp;        try {
<b class="fc">&nbsp;            userRepository.findById(userId).get();</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            throw new NotFoundException(&quot;???????????? ?? ??????&quot;);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
&nbsp;        List&lt;Booking&gt; bookings;
&nbsp;
<b class="fc">&nbsp;        if (from == null &amp;&amp; size == null) {</b>
<b class="fc">&nbsp;            from = 0;</b>
<b class="fc">&nbsp;            size = Integer.MAX_VALUE;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        PageRequest pageRequest = getPage(from, size);</b>
&nbsp;
<b class="fc">&nbsp;        switch (bookingState) {</b>
&nbsp;            case ALL:
<b class="fc">&nbsp;                bookings = bookingRepository.findAllBookingsByUserIdAndStatusWithFetch(userId, null, pageRequest);</b>
<b class="fc">&nbsp;                break;</b>
&nbsp;            case WAITING:
&nbsp;            case REJECTED:
<b class="fc">&nbsp;                var bookingStatus = bookingState.equals(BookingState.WAITING) ? BookingStatus.WAITING.toString() : BookingStatus.REJECTED.toString();</b>
<b class="fc">&nbsp;                bookings = bookingRepository.findAllBookingsByUserIdAndStatusWithFetch(userId, bookingStatus, pageRequest);</b>
<b class="fc">&nbsp;                break;</b>
&nbsp;            case CURRENT:
<b class="fc">&nbsp;                bookings = bookingRepository.findAllCurrentBookingsByUserIdWithFetch(userId, LocalDateTime.now(), pageRequest);</b>
<b class="fc">&nbsp;                break;</b>
&nbsp;            case PAST:
<b class="fc">&nbsp;                bookings = bookingRepository.findAllPastBookingsByUserIdWithFetch(userId, LocalDateTime.now(), pageRequest);</b>
<b class="fc">&nbsp;                break;</b>
&nbsp;            case FUTURE:
<b class="fc">&nbsp;                bookings = bookingRepository.findAllFutureBookingsByUserIdWithFetch(userId, LocalDateTime.now(), pageRequest);</b>
<b class="fc">&nbsp;                break;</b>
&nbsp;            default:
<b class="nc">&nbsp;                throw new NotFoundException(&quot;&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return bookings.stream()</b>
<b class="fc">&nbsp;                .map(x -&gt; BookingMapper.toExtendedBookingDto(x))</b>
<b class="fc">&nbsp;                .collect(Collectors.toList());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    public BookingExtendedDto setBookingStatus(Integer userId, Integer bookingId, BookingStatus bookingStatus) {
<b class="fc">&nbsp;        log.info(&quot;??????? ?????? ? ??????: {}. ???????? ??????????: {}, {}, {}&quot;, &quot;setBookingStatus&quot;, userId, bookingId, bookingStatus);</b>
&nbsp;
<b class="fc">&nbsp;        var booking = bookingRepository.findById(bookingId).get();</b>
&nbsp;
<b class="fc">&nbsp;        if (!booking.getStatus().equals(BookingStatus.WAITING)) {</b>
<b class="fc">&nbsp;            throw new InvalidParameterException(&quot;?????? ???????????? ?? ????? ???? ???????&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (!booking.getItem().getOwner().getId().equals(userId)) {</b>
<b class="nc">&nbsp;            throw new NotFoundException(&quot;?????? ????? ???? ??????? ?????? ?????????? ????&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        booking.setStatus(bookingStatus);</b>
<b class="fc">&nbsp;        booking = bookingRepository.save(booking);</b>
<b class="fc">&nbsp;        return BookingMapper.toExtendedBookingDto(booking);</b>
&nbsp;    }
&nbsp;
&nbsp;    private PageRequest getPage(Integer from, Integer size) {
<b class="fc">&nbsp;        if (from &lt; 0 || size &lt; 1) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Not valid page arams&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        var pageIndex = from / size;</b>
&nbsp;
<b class="fc">&nbsp;        return PageRequest.of(pageIndex, size);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-07-24 01:39</div>
</div>
</body>
</html>
